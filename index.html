<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Disk Usage Reporting</title>

<!-- Disk Usage Reports Version 1.0 Beta -->

<script type="text/javascript">
	// Path to the directory that contains the reports.
	// Example: document.reportsBaseURL = '/path/to/me/';
	document.reportsBaseURL = 'data/';
</script>

<link rel="shortcut icon" href="images/favicon.png" type="image/png" /> 
<link href="css/jquery.ui.tree.css" type="text/css" rel="stylesheet" />
<link href="css/layout.css" type="text/css" rel="stylesheet" />

<!-- External Scripts -->
<script type="text/javascript" src="js/external/jquery.min.js"></script>
<script type="text/javascript" src="js/external/jquery.ui.core.js"></script>
<script type="text/javascript" src="js/external/jquery.ui.widget.js"></script>
<script type="text/javascript" src="js/external/jquery.ui.mouse.js"></script>
<script type="text/javascript" src="js/external/jquery.ui.position.js"></script>
<script type="text/javascript" src="js/external/jquery.sortelements.js"></script>
<script type="text/javascript" src="js/external/jquery.json.js"></script>
<script type="text/javascript" src="js/external/jquery.scrollbarwidth.js"></script>
<script type="text/javascript" src="js/external/rsh.js"></script>

<!-- Disk Usage Reporting Scripts -->
<script type="text/javascript" src="js/general.js"></script>
<script type="text/javascript" src="js/jquery.scrollintoview.js"></script>
<script type="text/javascript" src="js/jquery.ui.tree.js"></script>
<script type="text/javascript" src="js/viewer.js"></script>

<style type="text/css">
	tbody th {
		text-align: right;
	}
</style>

<!-- Disk Usage Reporting Scripts -->
<script type="text/javascript">
	
	// Override the JSON methods in RSH.
	window.dhtmlHistory.create({
		toJSON: function(o) {
			return $.toJSON(o);
		},
		fromJSON: function(s) {
			return $.evalJSON(s);
		}
	});
	
	// Initialize RSH once the page loads.
	window.onload = function() {
		dhtmlHistory.initialize();
		dhtmlHistory.addListener(function(newLocation, historyData) {
			$(document).trigger('dhtmlhistory', [ newLocation, historyData ]);
		});
	};
	
	// Set up history handling.
	$(document).bind('dhtmlhistory', function(e, location, data) {
		if (document.viewer) document.viewer.display(location);
	});
	
	$(function() {
		
		// Calculate the width (which caches it).
		$.scrollbarWidth();
		
		var settings,
			ajaxStage,
			debugTimeout = 50;
		
		$('#Loading').text('Loading Report Settings...');
		
		var finalSetup = function(directories){
			$('#Loading').text('Displaying Report...');
			setTimeout(function(){ // Debugging timeout
				
				document.viewer = new Viewer({
					directories: directories,
					settings: settings,
					report: window.location.search.substring(1)
				});
				
				document.viewer.display(dhtmlHistory.getCurrentLocation(), function(){
					$('#Loading').hide();
					$('#Columns').show();
					
					// Force a resize since the viewer is now displayed.
					document.resizeWindow();
					
					$('#LeftColumnScroller').scrollIntoView($('#DirectoryTree li.selected'));
				});
			
			}, debugTimeout); // Debugging timeout
		};
		
		var skipDirectoryList = function(){
			settings.directorytree = false;
			if (document.xhr_directories) document.xhr_directories.abort();
			$('#LeftColumn, #LeftColumnResizer').hide();
			finalSetup(null);
			return false;
		};
		
		var ajaxErrorHandler = function(xhr, status, err){
			var parts = [];
			switch (status) {
				case 'parsererror':
					parts.push('Error: Data is invalid or could not be parsed. ');
					if (ajaxStage == 'directories') {
						parts.push($('<a href="#">Skip the Directory List</a>').click(skipDirectoryList));
					}
					break;
				case 'timeout':
					parts.push('Error: Download took to long and timed out. Reload to try again');
					if (ajaxStage == 'directories') {
						parts.push(' or ');
						parts.push($('<a href="#">skip the directory list</a>').click(skipDirectoryList));
					}
					parts.push('.');
					break;
				case 'error':
					switch (xhr.status) {
						case 404:
							parts.push('Error: Not found. ');
							if (ajaxStage == 'directories') {
								parts.push('The directory list may not exist. ');
								if (ajaxStage == 'directories') {
									parts.push($('<a href="#">Skip the Directory List</a>').click(skipDirectoryList));
								}
							}
							else {
								parts.push('The report may not exist.');
							}
							break;
						case 401:
							parts.push('Error: A username and password is required. Reload to try again.');
							break;
						default:
							parts.push('Error: An unknown error occurred (' + xhr.status + '). Reload to try again');
							if (ajaxStage == 'directories') {
								parts.push(' or ');
								parts.push($('<a href="#">skip the directory list</a>').click(skipDirectoryList));
							}
							parts.push('.');
							$.dumpWindow(xhr);
					}
					break;
				default:
					parts.push('Error: An unknown error occurred. Reload to try again');
					if (ajaxStage == 'directories') {
						parts.push(' or ');
						parts.push($('<a href="#">skip the directory list</a>').click(skipDirectoryList));
					}
					parts.push('.');
			}
			
			var newMsg = $('<div>').appendTo($('#Loading'));
			for (var i = 0; i < parts.length; i++) {
				newMsg.append(parts[i]);
			}
		};
		
		setTimeout(function(){ // Debugging timeout
			
			ajaxStage = 'settings';
		
			// Load the settings file.
			document.xhr_settings = $.ajax({
				cache: false,
				url: document.reportsBaseURL + window.location.search.substring(1) + '/settings',
				type: 'GET',
				dataType: 'json',
				error: ajaxErrorHandler,
				success: function(data, status, xhr){
					settings = data;
					
					if (settings.name) {
						$('#Title > span').append(' for: ').append($('<b>').text(settings.name));
					}
					
					if (settings.errors.length > 0) {
						
						// Display the number of errors.
						$('#ErrorCount').text('Errors: ' + settings.errors.length).disableTextSelection().show();
						
						// Populate the error list.
						for (var i = 0; i < settings.errors.length; i++) {
							var detail = '',
								errorTitle = 'Unknown Error (' + settings.errors[i] + ')';
							
							switch (settings.errors[i][0]) {
								case 'invalidline':
									errorTitle = 'Invalid Line - ';
									switch (settings.errors[i][1]) {
										case 'regex':
											errorTitle += 'Wrong Format';
											detail += '<div style="overflow: auto; width: 100%;">'+ settings.errors[i][2].htmlencode() +'</div>';
											break;
										case 'maxlinelength':
											errorTitle += 'Line Too Long (' + settings.errors[i][2].length + ' characters)';
											detail += '<div style="overflow: auto; width: 100%;">'+ settings.errors[i][2].htmlencode() +'</div>';
											break;
										case 'columncount':
											errorTitle += 'Wrong Column Count (' + settings.errors[i][2].length + ')';
											detail += '<table class="styledtable" border="1" cellspacing="0" cellpadding="4"><tbody><tr class="odd">';
											for (var c = 0; c < settings.errors[i][2].length; c++) {
												detail += '<td>' + settings.errors[i][2][c].htmlencode() + '</td>';
											}
											detail += '</tr></tbody></table>';
											break;
										case 'column':
											errorTitle += 'Bad Value for Column \'' + settings.errors[i][2] + '\'';
											detail += '<table class="styledtable" border="1" cellspacing="0" cellpadding="4"><tbody><tr class="odd">';
											for (var c = 0; c < settings.errors[i][4].length; c++) {
												detail += '<td ' + (c == settings.errors[i][3] ? ' style="background-color: #FF0;"' : '') + '>' + settings.errors[i][4][c].htmlencode() + '</td>';
											}
											detail += '</tr></tbody></table>';
											break;
										default:
											errorTitle += 'Unknown Error (' + settings.errors[i][1] + ')';
									}
									errorTitle += ':';
									break;
								case 'writefail':
									errorTitle = 'Error Writing File (' + settings.errors[i][2].htmlencode() + ') for:'
									detail += '<div style="overflow: auto; width: 100%;">'+ settings.errors[i][1].htmlencode() +'</div>';
									break;
							}
							var errorItem = $('<div>').addClass('errors-item').html('<b>' + errorTitle.htmlencode() + '</b>').appendTo($('#ErrorsList'));
							if (detail != '') errorItem.append(detail);
						}
					}
					
					$('#Created').text(' on ' + settings.created);
					
					if (settings.directorytree) {
						$('#Loading').text('Loading Directory List for Report...');
						
						setTimeout(function(){ // Debugging timeout
							
							document.timeout_skip = setTimeout(function(){
								$('#Loading').append($('<div id="DirectoryListSkip"></div>').text('Taking too long? ').append($('<a href="#">Skip the Directory List</a>').click(skipDirectoryList)));
							}, 1000);
							
							ajaxStage = 'directories';
							
							// Load the directory lookup file.
							document.xhr_directories = $.ajax({
								cache: false,
								url: document.reportsBaseURL + window.location.search.substring(1) + '/directories',
								type: 'GET',
								dataType: 'json',
								error: function(xhr, status, err) {
									// If directorytree is false then the user is asking to skip it.
									if (settings.directorytree)
										ajaxErrorHandler(xhr, status, err);
								},
								success: function(directories, status, xhr){
									if ($.isUndefined(directories[settings.root])) {
										$('#Loading').append($('<div>').text('Error: The root directory could not be found in the directory list.'));
									}
									else if (settings.directorytree) {
										finalSetup(directories);
									}
								},
								complete: function() {
									if (document.timeout_skip) clearTimeout(document.timeout_skip);
									$('#DirectoryListSkip').remove();
								}
							});
							
						}, debugTimeout); // Debugging timeout
					}
					
					else {
						$('#LeftColumn, #LeftColumnResizer').hide();
						finalSetup(null);
					}
				}
			});
		
		}, debugTimeout); // Debugging timeout
	
		// Load the location on first load.
		if (dhtmlHistory.isFirstLoad()) {
			
		}
		
		document.resizeWindow = function() {
			var footerHeight = $('#Footer').outerHeight();
			
			// Set the correct height for the container.
			var containerHeightDiff = $('#Container').outerHeight(true) - $('#Container').height();
			$('#Container').height($('body').height() - containerHeightDiff - $('#Container').offset().top - footerHeight - 5);
			
			if ($('#Errors').is(':visible')) {
				var errorsHeightDiff = $('#ErrorsInner').outerHeight(true) - $('#ErrorsInner').height();
				$('#ErrorsInner').height($('#Errors').height() - errorsHeightDiff);
				
				var errorsScrollerHeightDiff = $('#ErrorsScroller').outerHeight(true) - $('#ErrorsScroller').height();
				$('#ErrorsScroller').height($('#ErrorsInner').height() - errorsScrollerHeightDiff - $('#ErrorsScroller').position().top);
			}
				
			if ($('#LeftColumn').is(':visible')) {
				var leftColumnBorderHeightDiff = $('#LeftColumnBorder').outerHeight(true) - $('#LeftColumnBorder').height();
				$('#LeftColumnBorder').height($('#LeftColumn').height() - leftColumnBorderHeightDiff);
				
				var leftColumnScrollerHeightDiff = $('#LeftColumnScroller').outerHeight(true) - $('#LeftColumnScroller').height();
				$('#LeftColumnScroller').height($('#LeftColumnBorder').height() - $('#LeftColumnScroller').position().top - leftColumnScrollerHeightDiff);
				
				$('#LeftColumn').width(Math.max(100, Math.min($('#Columns').width() - 200, $('#LeftColumn').width())));
			}
			
			if ($('#Report').is(':visible')) {
				var reportHeightDiff = $('#Report').outerHeight(true) - $('#Report').height();
				$('#Report').height($('#RightColumn').height() - reportHeightDiff - $('#Report').position().top);
			}
		};
		
		$(window)
			.resize(function(){
				if (document.timeout_resize) clearTimeout(document.timeout_resize);
				document.timeout_resize = setTimeout(function() {
					document.resizeWindow();
				}, 100);
			});
		
		document.resizeWindow();
		
		$('#ErrorCount').click(function() {
			$('#Errors, #Dimmer').show();
			document.resizeWindow();
		});
		$('#ErrorsTitle div').click(function() {
			$('#Errors, #Dimmer').hide();
		});
		
		$('#LeftColumnResizer').disableTextSelection().mousedown(function(evDown){
			var startX = evDown.screenX;
			var origWidth = $('#LeftColumn').width();
			
			$(document).bind('mousemove.resizer', function(evMove){
				$('#LeftColumn').width(Math.max(100, Math.min($('#Columns').width() - 200, origWidth + evMove.screenX - startX)));
				
				if (document.timeout_resize) clearTimeout(document.timeout_resize);
				document.timeout_resize = setTimeout(function() {
					document.resizeWindow();
				}, 100);
			});
			
			$(document).one('mouseup', function(evUp){
				//$('#LeftColumn').width(origWidth + evUp.screenX - startX);
				$(document).unbind('mousemove.resizer');
			})
		});
	});
</script>
</head>
<body>
	
<div id="Title">Disk Usage Report <span></span></div>

<div style="position: relative;"><div id="ErrorCount" style="display: none;"></div></div>

<div id="Dimmer"></div>

<div id="Container">
	<div id="Loading"></div>
	
	<div id="Errors">
		<div id="ErrorsInner">
			<div id="ErrorsTitle"><div>Close</div>Errors While Processing Report:</div>
			<div id="ErrorsScroller">
				<div id="ErrorsList"></div>
			</div>
		</div>
	</div>
	
	<div id="Columns" style="display: none;">
		
		<div id="LeftColumn">
			<div id="LeftColumnBorder">
				<table class="styledtable" width="100%" id="TreeSort" border="0" cellspacing="0" cellpadding="4">
					<thead>
						<tr>
							<th class="tree-sortby-label"><span>Name</span></th>
							<th class="tree-sortby-byte" colspan="3"><span>Size</span></th>
							<th class="tree-sortby-num" colspan="3"><span>Count</span></th>
						</tr>
					</thead>
				</table>
				<div id="LeftColumnScroller">
					<div id="DirectoryTree"></div>
				</div>
			</div>
		</div>
		
		<div id="LeftColumnResizer"></div>
		
		<div id="Error" style="display: none;"></div>
		
		<div id="RightColumn">
			
			<div id="ReportHead">
				<div id="Path"></div>
				<div id="DirSummary">Total Size: <span id="TotalBytes"></span> (<span id="Bytes"></span> in this directory alone)<br/>
					Total Files: <span id="TotalNum"></span> (<span id="Num"></span> in this directory alone)</div>
			</div>
			
			<div id="Tabs">
				<ul>
					<li id="Tab_SubDirs">Contents</li>
					<li id="Tab_Files">File List</li>
					<li id="Tab_Modified">Last Modified</li>
					<li id="Tab_Sizes">File Sizes</li>
					<li id="Tab_Types">File Types</li>
					<li id="Tab_Top100">Top 100</li>
				</ul>
			</div>
			
			<div id="Report">
		
				<div id="Sections">
				
					<div id="Section_SubDirs">
						<table class="styledtable" id="SubDirs" border="1" cellspacing="0" cellpadding="4">
							<thead>
								<tr>
									<th class="totals-sortby-label"><span>Name</span></th>
									<th class="totals-sortby-byte" colspan="3"><span>Total Size</span></th>
									<th class="totals-sortby-num" colspan="3"><span>File Count</span></th>
								</tr>
							</thead>
							<tfoot>
								<td>Total</td>
								<td colspan="3"></td>
								<td colspan="3"></td>
							</tfoot>
							<tbody>
								
							</tbody>
						</table>
					</div>
					
					<div id="Section_Modified">
						<table class="styledtable" id="Modified" border="1" cellspacing="0" cellpadding="4">
							<thead>
								<tr>
									<th class="totals-sortby-label"><span>Age</span></th>
									<th class="totals-sortby-byte" colspan="3"><span>Total Size</span></th>
									<th class="totals-sortby-num" colspan="3"><span>File Count</span></th>
								</tr>
							</thead>
							<tfoot>
								<td>Total</td>
								<td colspan="3"></td>
								<td colspan="3"></td>
							</tfoot>
							<tbody>
								
							</tbody>
						</table>
					</div>
					
					<div id="Section_Sizes">
						<table class="styledtable" id="Sizes" border="1" cellspacing="0" cellpadding="4">
							<thead>
								<tr>
									<th class="totals-sortby-label"><span>Range</span></th>
									<th class="totals-sortby-byte" colspan="3"><span>Total Size</span></th>
									<th class="totals-sortby-num" colspan="3"><span>File Count</span></th>
								</tr>
							</thead>
							<tfoot>
								<td>Total</td>
								<td colspan="3"></td>
								<td colspan="3"></td>
							</tfoot>
							<tbody>
								
							</tbody>
						</table>
					</div>
					
					<div id="Section_Types">
						<table class="styledtable" id="Types" border="1" cellspacing="0" cellpadding="4">
							<thead>
								<tr>
									<th class="totals-sortby-label"><span>Extension</span></th>
									<th class="totals-sortby-byte" colspan="3"><span>Total Size</span></th>
									<th class="totals-sortby-num" colspan="3"><span>File Count</span></th>
								</tr>
							</thead>
							<tfoot>
								<td>Total</td>
								<td colspan="3"></td>
								<td colspan="3"></td>
							</tfoot>
							<tbody>
								
							</tbody>
						</table>
					</div>
					
					<div id="Section_Files">
						<table class="styledtable" id="Files" border="1" cellspacing="0" cellpadding="4">
							<thead>
								<tr>
									<th id="Files-SortBy-name"><span>Name</span></th>
									<th id="Files-SortBy-type"><span>Type</span></th>
									<th id="Files-SortBy-size"><span>Size</span></th>
									<th id="Files-SortBy-modified"><span>Modified</span></th>
								</tr>
							</thead>
							<tbody>
								
							</tbody>
						</table>
					</div>
					
					<div id="Section_Top100">
						<table class="styledtable" id="Top100" border="1" cellspacing="0" cellpadding="4">
							<thead>
								<tr>
									<th id="Top100-SortBy-name"><span>Name</span></th>
									<th id="Top100-SortBy-type"><span>Type</span></th>
									<th id="Top100-SortBy-size"><span>Size</span></th>
									<th id="Top100-SortBy-modified"><span>Modified</span></th>
									<th id="Top100-SortBy-path"><span>Path</span></th>
								</tr>
							</thead>
							<tbody>
								
							</tbody>
						</table>
					</div>
					
					<div id="Section_Message" style="display: none;"></div>
				
				</div>
			
			</div> <!-- Report -->
		
		</div> <!-- Right Column -->
	
	</div> <!-- Columns -->

</div> <!-- Container -->

<div id="Footer">Report Generated <span id="Created"></span> using <a href="http://diskusagereport.sourceforge.net/" target="_blank">Disk Usage Reports</a></div>

</body>
</html>